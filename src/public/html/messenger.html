<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evently Messenger</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link rel="stylesheet" href="../css/styles.css" />

    <style>
      /* Messenger layout - Premium SP Theme */
      body.app-shell {
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .msgr-wrap {
        flex: 1;
        display: flex;
        gap: 20px;
        padding: 20px 24px;
        background: var(--msgr-bg, #f8f9fa);
        background-image: var(--msgr-bg-image, none);
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        height: calc(100vh - 72px);
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        transition: background 0.3s ease;
      }

      /* Sidebar */
      .msgr-side {
        width: 360px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.8);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
        transition: transform 0.3s ease;
      }

      /* ✅ FIX: allow sidebar children to scroll properly in flex */
      .msgr-side {
        min-height: 0; /* critical for nested scrolling */
      }

      .msgr-side header {
        padding: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        background: transparent;
      }

      .msgr-title {
        font-size: 1.25rem;
        font-weight: 800;
        color: #111827;
        letter-spacing: -0.02em;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #c8102e, #a00d24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Theme Controls */
      .theme-controls {
        position: fixed;
        bottom: 100px;
        right: 20px;
        z-index: 1000;
      }

      .theme-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c8102e, #a00d24);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        box-shadow: 0 4px 12px rgba(200, 16, 46, 0.3);
        cursor: pointer;
        transition: transform 0.2s;
      }

      .theme-btn:hover {
        transform: scale(1.05);
      }

      .theme-panel {
        position: fixed;
        bottom: 160px;
        right: 20px;
        width: 300px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(229, 231, 235, 0.8);
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .theme-panel.show {
        display: block;
      }

      .theme-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e7eb;
      }

      .theme-header h5 {
        margin: 0;
        font-weight: 700;
        color: #111827;
      }

      .theme-close {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 1.2rem;
      }

      .theme-presets {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }

      .theme-preset {
        height: 60px;
        border-radius: 12px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        background-size: cover;
        background-position: center;
      }

      .theme-preset:hover {
        transform: translateY(-2px);
      }

      .theme-preset.active {
        border-color: #c8102e;
        box-shadow: 0 0 0 3px rgba(200, 16, 46, 0.2);
      }

      .theme-preset.sp-default {
        background: linear-gradient(135deg, #c8102e, #0f172a);
      }

      .theme-preset.sp-gradient {
        background: linear-gradient(135deg, #667eea, #764ba2);
      }

      .theme-preset.sp-nature {
        background: linear-gradient(135deg, #4ade80, #22d3ee);
      }

      .theme-preset.sp-sunset {
        background: linear-gradient(135deg, #f97316, #ec4899);
      }

      .theme-preset.sp-ocean {
        background: linear-gradient(135deg, #0ea5e9, #6366f1);
      }

      .theme-preset.sp-night {
        background: linear-gradient(135deg, #1e293b, #0f172a);
      }

      .custom-upload {
        margin: 15px 0;
      }

      .upload-label {
        display: block;
        width: 100%;
        padding: 12px;
        background: #f3f4f6;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .upload-label:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
      }

      .upload-label input {
        display: none;
      }

      .upload-preview {
        margin-top: 10px;
        display: none;
      }

      .upload-preview img {
        width: 100%;
        border-radius: 12px;
        max-height: 150px;
        object-fit: cover;
      }

      .theme-controls-group {
        margin-top: 15px;
      }

      .theme-controls-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
      }

      .blur-slider {
        width: 100%;
        height: 4px;
        -webkit-appearance: none;
        background: #e5e7eb;
        border-radius: 2px;
        outline: none;
      }

      .blur-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #c8102e;
        cursor: pointer;
      }

      .blur-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #c8102e;
        cursor: pointer;
        border: none;
      }

      .blur-value {
        text-align: right;
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 5px;
      }

      .opacity-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .opacity-btn {
        flex: 1;
        padding: 8px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85rem;
        transition: all 0.2s;
      }

      .opacity-btn:hover {
        background: #e5e7eb;
      }

      .opacity-btn.active {
        background: #c8102e;
        color: white;
        border-color: #c8102e;
      }

      .theme-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .theme-actions button {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }

      .theme-save {
        background: linear-gradient(135deg, #c8102e, #a00d24);
        color: white;
      }

      .theme-reset {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      /* Search Inputs */
      .search-input {
        background: #f3f4f6;
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 10px 16px;
        font-size: 0.9rem;
        width: 100%;
        transition: all 0.2s;
      }
      .search-input:focus {
        background: #fff;
        border-color: #c8102e;
        box-shadow: 0 0 0 3px rgba(200, 16, 46, 0.08);
        outline: none;
      }

      /* List Items */
      .msgr-list {
        overflow-y: auto;
        flex: 1;
        min-height: 0;
        padding: 10px;
      }

      .msgr-item {
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 4px;
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
      }

      .msgr-item:hover {
        background: rgba(200, 16, 46, 0.1);
        transform: translateX(2px);
      }

      .msgr-item.active {
        background: rgba(200, 16, 46, 0.15);
        border-color: rgba(200, 16, 46, 0.2);
      }

      .msgr-item-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .msgr-item-preview {
        font-size: 0.85rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Main Chat Area */
      .msgr-main {
        flex: 1;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(229, 231, 235, 0.8);
        position: relative;
      }

      .msgr-top {
        padding: 16px 24px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        z-index: 10;
      }

      .msgr-unread {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        padding: 0 6px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 800;
        color: #fff;
        background: #dc2626;
      }

      #activeTitle {
        font-weight: 700;
        font-size: 1.1rem;
        color: #111827;
      }

      #activeSubtitle {
        font-size: 0.85rem;
        color: #6b7280;
      }

      /* Messages Area */
      .msgs {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(250, 250, 250, 0.7);
      }

      .bubble {
        max-width: 75%;
        padding: 12px 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        backdrop-filter: blur(5px);
      }

      /* My Messages (Right) */
      .me {
        align-self: flex-end;
        background: linear-gradient(
          135deg,
          rgba(200, 16, 46, 0.9),
          rgba(160, 13, 36, 0.9)
        );
        color: white;
        border-radius: 20px 20px 4px 20px;
        box-shadow: 0 4px 12px rgba(200, 16, 46, 0.25);
      }

      /* Their Messages (Left) */
      .them {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(229, 231, 235, 0.8);
        color: #1f2937;
        border-radius: 20px 20px 20px 4px;
      }

      .msg-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 4px;
        display: block;
        text-align: right;
      }

      /* =========================
   Messenger - Pro Message Row + Global Action Menu
   ========================= */

      .msg-row {
        display: flex;
        width: 100%;
      }

      .me-row {
        justify-content: flex-end;
      }

      .them-row {
        justify-content: flex-start;
      }

      .msg-row-sys {
        justify-content: center;
      }

      .msg-bubble {
        position: relative;
        padding-right: 44px; /* space for kebab */
      }

      .msg-sender {
        font-size: 12px;
        opacity: 0.75;
        margin-bottom: 4px;
      }

      .msg-text {
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      /* Clean “kebab” button (shows on hover/focus only) */
      .msg-kebab {
        position: absolute;
        top: 10px;
        right: 10px;

        width: 30px;
        height: 30px;
        border-radius: 10px;

        display: grid;
        place-items: center;
        gap: 3px;

        border: 1px solid rgba(229, 231, 235, 0.8);
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(10px);

        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
        cursor: pointer;

        opacity: 0;
        transform: translateY(-2px);
        transition:
          opacity 0.15s ease,
          transform 0.15s ease,
          background 0.15s ease;
      }

      .msg-bubble:hover .msg-kebab,
      .msg-kebab:focus-visible {
        opacity: 1;
        transform: translateY(0);
      }

      .msg-kebab:hover {
        background: rgba(255, 255, 255, 0.92);
      }

      .kebab-dot {
        width: 4px;
        height: 4px;
        border-radius: 999px;
        background: rgba(17, 24, 39, 0.65);
        display: block;
      }

      .me .kebab-dot {
        background: rgba(255, 255, 255, 0.8);
      }

      /* System bubble polish */
      .msg-bubble-sys {
        max-width: 70%;
        border-radius: 999px;
        padding: 10px 16px;
        background: rgba(17, 24, 39, 0.06);
        border: 1px solid rgba(15, 23, 42, 0.08);
        color: rgba(17, 24, 39, 0.75);
        box-shadow: none;
      }

      /* =========================
   Global Action Menu (Portal)
   ========================= */

      .msg-action-backdrop {
        position: fixed;
        inset: 0;
        background: transparent;
        z-index: 9998;
      }

      .msg-action-menu {
        position: fixed;
        min-width: 200px;
        border-radius: 16px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(16px);

        border: 1px solid rgba(229, 231, 235, 0.85);
        box-shadow:
          0 24px 80px rgba(0, 0, 0, 0.18),
          0 0 0 1px rgba(255, 255, 255, 0.6) inset;

        z-index: 9999;
        transform-origin: top right;
      }

      .msg-action-menu.pop {
        animation: menuPop 160ms ease;
      }

      @keyframes menuPop {
        from {
          transform: scale(0.98);
          opacity: 0.6;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .msg-action-item {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;

        border: none;
        background: transparent;

        padding: 10px 10px;
        border-radius: 12px;

        font-size: 0.92rem;
        font-weight: 600;
        color: #111827;

        cursor: pointer;
        transition:
          background 0.14s ease,
          transform 0.14s ease;
      }

      .msg-action-item:hover {
        background: rgba(200, 16, 46, 0.08);
        transform: translateY(-1px);
      }

      .msg-action-item.danger {
        color: #b91c1c;
      }

      .msg-action-item.danger:hover {
        background: rgba(185, 28, 28, 0.1);
      }

      .msg-action-ic {
        width: 22px;
        display: inline-flex;
        justify-content: center;
      }

      .msg-action-divider {
        height: 1px;
        background: rgba(15, 23, 42, 0.08);
        margin: 6px 6px;
        border-radius: 999px;
      }

      .hidden {
        display: none !important;
      }

      /* Composer Area */
      .composer {
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #f3f4f6;
        display: flex;
        gap: 12px;
        align-items: center;
        backdrop-filter: blur(10px);
      }

      .composer input {
        flex: 1;
        padding: 14px 20px;
        border-radius: 99px;
        border: 2px solid #f3f4f6;
        background: rgba(249, 250, 251, 0.9);
        transition: all 0.2s;
        font-size: 0.95rem;
        backdrop-filter: blur(5px);
      }

      .composer input:focus {
        border-color: #c8102e;
        background: rgba(255, 255, 255, 0.95);
        outline: none;
        box-shadow: 0 0 0 4px rgba(200, 16, 46, 0.05);
      }

      .composer button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #c8102e, #a00d24);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 12px rgba(200, 16, 46, 0.3);
      }

      .composer button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(200, 16, 46, 0.4);
      }

      .focus-msg {
        outline: 3px solid rgba(220, 38, 38, 0.6);
        box-shadow: 0 0 0 6px rgba(220, 38, 38, 0.12);
        transition:
          outline 0.2s ease,
          box-shadow 0.2s ease;
      }

      /* Small Utility Buttons */
      .smallbtn {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #4b5563;
        font-weight: 500;
        transition: all 0.2s;
      }
      .smallbtn:hover {
        border-color: #c8102e;
        color: #c8102e;
        background: #fff1f2;
      }

      /* Requests Panel */
      #dmRequestsWrap {
        margin-top: 16px;
        background: #fff1f2;
        border: 1px solid rgba(200, 16, 46, 0.1);
        border-radius: 12px;
        padding: 12px;
      }

      /* ✅ FIX: don't let Moderation eat the whole sidebar height */
      #modWrap {
        margin-top: 16px;
        background: #fffbeb;
        border: 1px solid rgba(245, 158, 11, 0.25);
        border-radius: 12px;
        padding: 12px;

        max-height: 260px; /* adjust if you want (220–320) */
        overflow-y: auto; /* moderation scrolls internally */
      }

      #modPanel {
        padding-right: 4px; /* prevents scrollbar overlay */
      }

      .panel-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #991b1b;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .msg-actions-wrap {
        position: absolute;
        top: 8px;
        right: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .msg-bubble {
        position: relative;
      }

      .msg-actions-btn {
        border: none;
        background: rgba(255, 255, 255, 0.75);
        width: 30px;
        height: 30px;
        border-radius: 10px;
        line-height: 1;
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .msg-actions-btn:hover {
        background: rgba(255, 255, 255, 0.95);
      }

      .msg-actions-menu {
        position: absolute;
        top: 36px;
        right: 0;
        min-width: 160px;
        background: white;
        border: 1px solid rgba(229, 231, 235, 0.9);
        border-radius: 12px;
        padding: 6px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
        z-index: 50;
      }

      .msg-actions-menu button {
        width: 100%;
        text-align: left;
        border: none;
        background: transparent;
        padding: 10px 10px;
        border-radius: 10px;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .msg-actions-menu button:hover {
        background: rgba(200, 16, 46, 0.08);
      }

      .msg-actions-menu button[data-action="delete"] {
        color: #b91c1c;
      }
      .msg-actions-menu button[data-action="delete"]:hover {
        background: rgba(185, 28, 28, 0.08);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .msgr-wrap {
          padding: 0;
          gap: 0;
        }
        .msgr-side {
          width: 100%;
          border-radius: 0;
          border: none;
          display: flex;
        }
        .msgr-main {
          display: none;
          width: 100%;
          border-radius: 0;
          border: none;
        }
        .theme-panel {
          width: calc(100% - 40px);
          left: 20px;
          right: 20px;
          bottom: 100px;
        }

        .msgr-wrap.show-chat .msgr-side {
          display: none;
        }
        .msgr-wrap.show-chat .msgr-main {
          display: flex;
        }
      }
    </style>
    <script src="../js/navbar.js" type="module" defer></script>
  </head>

  <body class="app-shell">
    <div class="msgr-wrap" id="messengerWrap">
      <div class="msgr-side">
        <header>
          <div class="msgr-title">Messages</div>

          <div class="d-flex gap-2 mb-2">
            <input
              id="dmSearch"
              class="search-input"
              placeholder="Start new chat (email/admin)..."
            />
            <button
              class="btn btn-dark rounded-circle"
              id="dmSearchBtn"
              style="width: 42px; height: 42px; padding: 0; background: #1f2937"
            >
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
          <div id="dmResults" class="small text-muted"></div>

          <div>
            <input
              id="convSearch"
              class="search-input"
              placeholder="Filter conversations..."
            />
          </div>

          <div id="dmRequestsWrap" style="display: none">
            <div class="panel-title">
              <span><i class="bi bi-inbox-fill me-2"></i>DM Requests</span>
              <button class="smallbtn py-1" id="refreshRequestsBtn">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div id="dmRequestsPanel">
              <div class="muted small fst-italic">Loading requests...</div>
            </div>
          </div>

          <!-- ✅ NEW: Moderation Queue (staff only) -->
          <div
            id="modWrap"
            style="
              display: none;
              margin-top: 14px;
              background: #fffbeb;
              border: 1px solid #fde68a;
              border-radius: 12px;
              padding: 12px;
            "
          >
            <div class="panel-title" style="color: #92400e">
              <span
                ><i class="bi bi-shield-exclamation me-2"></i>Moderation</span
              >
              <button class="smallbtn py-1" id="refreshModBtn">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div id="modPanel" class="small text-muted fst-italic">
              Loading...
            </div>
          </div>
        </header>

        <div class="msgr-list" id="conversationList"></div>
      </div>

      <div class="msgr-main">
        <div class="msgr-top">
          <div class="d-flex align-items-center gap-3">
            <div
              class="d-flex align-items-center justify-content-center bg-light rounded-circle"
              style="width: 40px; height: 40px"
            >
              <i class="bi bi-person-fill text-muted fs-5"></i>
            </div>
            <div>
              <div id="activeTitle">Select a chat</div>
              <div id="activeSubtitle">Your messages will appear here</div>
            </div>
          </div>

          <div class="d-flex gap-2">
            <input
              id="msgSearch"
              class="search-input py-1"
              style="width: 180px; font-size: 0.85rem"
              placeholder="Search in chat..."
            />
            <button class="smallbtn" id="msgSearchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <div
          class="pin"
          id="pinBox"
          style="
            display: none;
            background: #fff7ed;
            color: #c2410c;
            padding: 8px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid #ffedd5;
          "
        ></div>

        <div class="msgs" id="messages">
          <div class="text-center text-muted mt-5">
            <i class="bi bi-chat-square-text display-4 opacity-25"></i>
            <p class="mt-3">Select a conversation to start chatting</p>
          </div>
        </div>

        <div class="composer">
          <button
            class="smallbtn rounded-circle"
            id="loadOlderBtn"
            title="Load older messages"
            style="width: 40px; height: 40px; border-radius: 50%"
          >
            <i class="bi bi-clock-history"></i>
          </button>
          <input
            id="messageInput"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="sendBtn">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Theme Customizer -->
    <div class="theme-controls">
      <button class="theme-btn" id="themeToggleBtn" title="Change Theme">
        <i class="bi bi-palette"></i>
      </button>
    </div>

    <div class="theme-panel" id="themePanel">
      <div class="theme-header">
        <h5>Messenger Theme</h5>
        <button class="theme-close" id="themeCloseBtn">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <h6 class="mb-2">Preset Themes</h6>
      <div class="theme-presets">
        <div
          class="theme-preset sp-default active"
          data-theme="default"
          title="SP Default"
        ></div>
        <div
          class="theme-preset sp-gradient"
          data-theme="gradient"
          title="Purple Gradient"
        ></div>
        <div
          class="theme-preset sp-nature"
          data-theme="nature"
          title="Nature Green"
        ></div>
        <div
          class="theme-preset sp-sunset"
          data-theme="sunset"
          title="Sunset Orange"
        ></div>
        <div
          class="theme-preset sp-ocean"
          data-theme="ocean"
          title="Ocean Blue"
        ></div>
        <div
          class="theme-preset sp-night"
          data-theme="night"
          title="Night Mode"
        ></div>
      </div>

      <h6 class="mb-2 mt-3">Custom Background</h6>
      <div class="custom-upload">
        <label class="upload-label">
          <i class="bi bi-cloud-upload me-2"></i>
          Upload Custom Image
          <input type="file" id="bgUpload" accept="image/*" />
        </label>
        <div class="upload-preview" id="uploadPreview">
          <img id="previewImage" src="" alt="Preview" />
        </div>
      </div>

      <div class="theme-controls-group">
        <label for="blurSlider"
          >Background Blur: <span id="blurValue">5px</span></label
        >
        <input
          type="range"
          id="blurSlider"
          class="blur-slider"
          min="0"
          max="20"
          value="5"
          step="1"
        />
        <div class="blur-value">Adjust blur intensity</div>
      </div>

      <div class="theme-controls-group">
        <label>Chat Opacity</label>
        <div class="opacity-controls">
          <div class="opacity-btn active" data-opacity="0.9">High</div>
          <div class="opacity-btn" data-opacity="0.8">Medium</div>
          <div class="opacity-btn" data-opacity="0.7">Low</div>
          <div class="opacity-btn" data-opacity="1">Solid</div>
        </div>
      </div>

      <div class="theme-actions">
        <button class="theme-reset" id="resetThemeBtn">Reset</button>
        <button class="theme-save" id="saveThemeBtn">Save Theme</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="../js/messenger.js"></script>

    <script>
      // Theme Customizer JavaScript
      document.addEventListener("DOMContentLoaded", function () {
        const themeToggleBtn = document.getElementById("themeToggleBtn");
        const themeCloseBtn = document.getElementById("themeCloseBtn");
        const themePanel = document.getElementById("themePanel");
        const bgUpload = document.getElementById("bgUpload");
        const previewImage = document.getElementById("previewImage");
        const uploadPreview = document.getElementById("uploadPreview");
        const blurSlider = document.getElementById("blurSlider");
        const blurValue = document.getElementById("blurValue");
        const opacityBtns = document.querySelectorAll(".opacity-btn");
        const presetBtns = document.querySelectorAll(".theme-preset");
        const resetThemeBtn = document.getElementById("resetThemeBtn");
        const saveThemeBtn = document.getElementById("saveThemeBtn");
        const messengerWrap = document.getElementById("messengerWrap");

        // Current theme settings
        let currentTheme = {
          type: "preset",
          value: "default",
          blur: 5,
          opacity: 0.9,
          customImage: null,
        };

        // Load saved theme from localStorage
        function loadSavedTheme() {
          const saved = localStorage.getItem("messengerTheme");
          if (saved) {
            try {
              const theme = JSON.parse(saved);
              applyTheme(theme);
              currentTheme = theme;
              updateUI();
            } catch (e) {
              console.error("Failed to load saved theme:", e);
            }
          }
        }

        // Apply theme settings
        function applyTheme(theme) {
          const root = document.documentElement;

          // Apply background
          if (theme.type === "custom" && theme.customImage) {
            messengerWrap.style.backgroundImage = `url(${theme.customImage})`;
            messengerWrap.style.backgroundColor = "transparent";
          } else {
            messengerWrap.style.backgroundImage = "none";

            switch (theme.value) {
              case "gradient":
                messengerWrap.style.backgroundColor = "#667eea";
                messengerWrap.style.backgroundImage =
                  "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
                break;
              case "nature":
                messengerWrap.style.backgroundColor = "#4ade80";
                messengerWrap.style.backgroundImage =
                  "linear-gradient(135deg, #4ade80 0%, #22d3ee 100%)";
                break;
              case "sunset":
                messengerWrap.style.backgroundColor = "#f97316";
                messengerWrap.style.backgroundImage =
                  "linear-gradient(135deg, #f97316 0%, #ec4899 100%)";
                break;
              case "ocean":
                messengerWrap.style.backgroundColor = "#0ea5e9";
                messengerWrap.style.backgroundImage =
                  "linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%)";
                break;
              case "night":
                messengerWrap.style.backgroundColor = "#1e293b";
                messengerWrap.style.backgroundImage =
                  "linear-gradient(135deg, #1e293b 0%, #0f172a 100%)";
                break;
              default: // SP Default
                messengerWrap.style.backgroundColor = "#F8F9FA";
                messengerWrap.style.backgroundImage =
                  "radial-gradient(circle at top left, rgba(200, 16, 46, 0.03), transparent 60%), radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.03), transparent 60%)";
            }
          }

          // Apply blur
          messengerWrap.style.setProperty("--msgr-bg-blur", `${theme.blur}px`);

          // Apply opacity to chat elements
          document
            .querySelectorAll(
              ".msgr-side, .msgr-main, .msgr-item, .composer input, .bubble",
            )
            .forEach((el) => {
              if (
                el.classList.contains("me") ||
                el.classList.contains("them")
              ) {
                // Keep bubble colors but adjust opacity
                if (el.classList.contains("me")) {
                  el.style.background = el.style.background.replace(
                    /rgba?\([^)]+\)/,
                    `rgba(200, 16, 46, ${theme.opacity})`,
                  );
                } else {
                  el.style.background = el.style.background.replace(
                    /rgba?\([^)]+\)/,
                    `rgba(255, 255, 255, ${theme.opacity})`,
                  );
                }
              } else {
                const bg = window.getComputedStyle(el).backgroundColor;
                const rgba = bg.match(
                  /rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/,
                );
                if (rgba) {
                  if (rgba[4]) {
                    el.style.backgroundColor = `rgba(${rgba[1]}, ${rgba[2]}, ${rgba[3]}, ${theme.opacity})`;
                  } else {
                    el.style.backgroundColor = `rgba(${rgba[1]}, ${rgba[2]}, ${rgba[3]}, ${theme.opacity})`;
                  }
                }
              }
            });
        }

        // Update UI controls
        function updateUI() {
          // Update preset selection
          presetBtns.forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.theme === currentTheme.value) {
              btn.classList.add("active");
            }
          });

          // Update opacity buttons
          opacityBtns.forEach((btn) => {
            btn.classList.remove("active");
            if (
              Math.abs(parseFloat(btn.dataset.opacity) - currentTheme.opacity) <
              0.01
            ) {
              btn.classList.add("active");
            }
          });

          // Update blur slider
          blurSlider.value = currentTheme.blur;
          blurValue.textContent = `${currentTheme.blur}px`;

          // Update preview if custom image
          if (currentTheme.type === "custom" && currentTheme.customImage) {
            previewImage.src = currentTheme.customImage;
            uploadPreview.style.display = "block";
          } else {
            uploadPreview.style.display = "none";
          }
        }

        // Toggle theme panel
        themeToggleBtn.addEventListener("click", () => {
          themePanel.classList.toggle("show");
        });

        themeCloseBtn.addEventListener("click", () => {
          themePanel.classList.remove("show");
        });

        // Close panel when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !themePanel.contains(e.target) &&
            !themeToggleBtn.contains(e.target)
          ) {
            themePanel.classList.remove("show");
          }
        });

        // Preset theme selection
        presetBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            currentTheme.type = "preset";
            currentTheme.value = btn.dataset.theme;
            currentTheme.customImage = null;
            applyTheme(currentTheme);
            updateUI();
          });
        });

        // Custom image upload
        bgUpload.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          if (!file.type.match("image.*")) {
            alert("Please select an image file");
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            // 5MB limit
            alert("Image size should be less than 5MB");
            return;
          }

          const reader = new FileReader();
          reader.onload = function (event) {
            previewImage.src = event.target.result;
            uploadPreview.style.display = "block";

            currentTheme.type = "custom";
            currentTheme.value = "custom";
            currentTheme.customImage = event.target.result;
            applyTheme(currentTheme);
            updateUI();
          };
          reader.readAsDataURL(file);
        });

        // Blur slider
        blurSlider.addEventListener("input", function () {
          const blur = parseInt(this.value);
          blurValue.textContent = `${blur}px`;
          currentTheme.blur = blur;
          applyTheme(currentTheme);
        });

        // Opacity buttons
        opacityBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const opacity = parseFloat(btn.dataset.opacity);
            currentTheme.opacity = opacity;
            applyTheme(currentTheme);
            updateUI();
          });
        });

        // Reset theme
        resetThemeBtn.addEventListener("click", () => {
          currentTheme = {
            type: "preset",
            value: "default",
            blur: 5,
            opacity: 0.9,
            customImage: null,
          };
          applyTheme(currentTheme);
          updateUI();
          localStorage.removeItem("messengerTheme");
        });

        // Save theme
        saveThemeBtn.addEventListener("click", () => {
          localStorage.setItem("messengerTheme", JSON.stringify(currentTheme));
          alert("Theme saved! It will be applied automatically next time.");
          themePanel.classList.remove("show");
        });

        // Initialize
        loadSavedTheme();
        updateUI();
      });
    </script>

    <link rel="stylesheet" href="../css/chatbot.css" />

    <div id="chatbot-container">
      <button id="chatbot-fab" class="chatbot-fab" title="Open AI Assistant">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
          ></path>
        </svg>
      </button>

      <div id="chatbot-modal" class="chatbot-modal hidden">
        <div class="chatbot-header">
          <div class="chatbot-title">
            <h3>AI Assistant</h3>
            <p>Ask me anything about Evently</p>
          </div>
          <button
            id="chatbot-close"
            class="chatbot-close"
            title="Close chatbot"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <div id="chatbot-messages" class="chatbot-messages">
          <div class="chatbot-message bot-message">
            <div class="message-content">
              <p>Hi! I'm your AI Assistant. How can I help you today?</p>
            </div>
          </div>
        </div>

        <div class="chatbot-input-area">
          <input
            id="chatbot-input"
            type="text"
            class="chatbot-input"
            placeholder="Type your message..."
            autocomplete="off"
          />
          <button id="chatbot-send" class="chatbot-send" title="Send message">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <script src="../js/chatbot.js"></script>
    <!-- ✅ Global Message Action Menu (Portal) -->
    <div id="msgActionBackdrop" class="msg-action-backdrop hidden"></div>
    <div id="msgActionMenu" class="msg-action-menu hidden" role="menu"></div>
  </body>
</html>
